---
applyTo: 'src/slicer/gcode/**/*.coffee'
---

# G-code Generation Overview

The G-code module generates Marlin-compatible commands for FDM 3D printers. All coder methods are in `src/slicer/gcode/coders.coffee`.

## Purpose

Generate properly formatted G-code commands for:
- Movement (linear, arc, Bézier)
- Temperature control (nozzle, bed)
- Fan control
- Position management
- Print sequencing (pre-print, post-print)

## Key Design Principle

**Coder methods should NOT perform unit conversions.** They always use internal standard units:
- Length: millimeters
- Speed: mm/s (converted to mm/min for G-code)
- Temperature: Celsius

This prevents double conversions when the `slice()` method calls coders.

## G-code Command Reference

### Movement Commands

| Method | G-code | Marlin Reference |
|--------|--------|------------------|
| `codeLinearMovement` | G0/G1 | [G000-G001](https://marlinfw.org/docs/gcode/G000-G001.html) |
| `codeArcMovement` | G2/G3 | [G002-G003](https://marlinfw.org/docs/gcode/G002-G003.html) |
| `codeBézierMovement` | G5 | [G005](https://marlinfw.org/docs/gcode/G005.html) |
| `codeAutohome` | G28 | [G028](https://marlinfw.org/docs/gcode/G028.html) |

### Temperature Commands

| Method | G-code | Marlin Reference |
|--------|--------|------------------|
| `codeNozzleTemperature` | M104/M109 | [M104](https://marlinfw.org/docs/gcode/M104.html), [M109](https://marlinfw.org/docs/gcode/M109.html) |
| `codeBedTemperature` | M140/M190 | [M140](https://marlinfw.org/docs/gcode/M140.html), [M190](https://marlinfw.org/docs/gcode/M190.html) |
| `codeTemperatureUnit` | M149 | [M149](https://marlinfw.org/docs/gcode/M149.html) |

### Fan Commands

| Method | G-code | Marlin Reference |
|--------|--------|------------------|
| `codeFanSpeed` | M106/M107 | [M106](https://marlinfw.org/docs/gcode/M106.html), [M107](https://marlinfw.org/docs/gcode/M107.html) |
| `codeFanReport` | M123 | [M123](https://marlinfw.org/docs/gcode/M123.html) |

### Position & Mode Commands

| Method | G-code | Marlin Reference |
|--------|--------|------------------|
| `codePositioningMode` | G90/G91 | [G090-G091](https://marlinfw.org/docs/gcode/G090-G091.html) |
| `codeExtruderMode` | M82/M83 | [M082-M083](https://marlinfw.org/docs/gcode/M082-M083.html) |
| `codeSetPosition` | G92 | [G092](https://marlinfw.org/docs/gcode/G092.html) |
| `codeWorkspacePlane` | G17/G18/G19 | [G017-G019](https://marlinfw.org/docs/gcode/G017-G019.html) |
| `codeLengthUnit` | G20/G21 | [G020-G021](https://marlinfw.org/docs/gcode/G020-G021.html) |

### Utility Commands

| Method | G-code | Marlin Reference |
|--------|--------|------------------|
| `codeMessage` | M117 | [M117](https://marlinfw.org/docs/gcode/M117.html) |
| `codeDwell` | G4/M0 | [G004](https://marlinfw.org/docs/gcode/G004.html), [M000-M001](https://marlinfw.org/docs/gcode/M000-M001.html) |
| `codeTone` | M300 | [M300](https://marlinfw.org/docs/gcode/M300.html) |
| `codeShutdown` | M112 | [M112](https://marlinfw.org/docs/gcode/M112.html) |
| `codeDisableSteppers` | M84 | [M084](https://marlinfw.org/docs/gcode/M084.html) |
| `codeWait` | M400 | [M400](https://marlinfw.org/docs/gcode/M400.html) |

## Speed Conversion

G-code uses mm/min for feedrate (F parameter), but Polyslice stores speeds in mm/s internally:

```coffeescript
# Convert mm/s to mm/min using polyconvert
feedratePerMin = Math.round(polyconvert.speed.millimeterSecond.millimeterMinute(retractSpeed))
```

## Pre-Print Sequence

`codePrePrint()` generates:
1. Metadata header (if enabled)
2. Start heating nozzle and bed (M104, M140 - non-blocking)
3. Auto-home (G28)
4. Raise Z to protect bed while heating
5. Wait for temperatures (M109, M190 - blocking)
6. Set extrusion mode (M82/M83)
7. Set workspace plane and units
8. Test strip (if enabled)
9. Reset extruder position (G92 E0)
10. Initial retraction

## Post-Print Sequence

`codePostPrint()` generates:
1. Turn off fan (M107)
2. Relative positioning (G91)
3. Wipe nozzle (if enabled)
4. Retract and raise Z
5. Absolute positioning (G90)
6. Present print (G28 X Y)
7. Turn off heaters (M104 S0, M140 S0)
8. Disable steppers (M84)
9. Buzzer (if enabled)

## Fan Speed Calculation

Fan speed is stored as percentage (0-100) but G-code uses 0-255:

```coffeescript
gcode = "M106" + " S" + Math.round(speed * 2.55)
```

## Retraction

```coffeescript
# Retract
gcode = "G1 E-" + retractDistance + " F" + feedratePerMin

# Unretract (prime)
gcode = "G1 E" + retractDistance + " F" + feedratePerMin
```

## Metadata Header

Generates comments with print information:
```gcode
; Generated by Polyslice
; Version: X.Y.Z
; Timestamp: 2024-01-01T12:00:00.000Z
; Repository: https://github.com/jgphilpott/polyslice
; Printer: Ender3
; Filament: Generic PLA (pla)
; Nozzle Temp: 200°C
; Bed Temp: 60°C
; Layer Height: 0.2mm
```

## Verbose Mode

When `verbose` is enabled, descriptive comments are appended to commands:

```coffeescript
gcode.replace(slicer.newline, "; Home All Axes" + slicer.newline)
```

## Important Conventions

1. **Always include slicer.newline** at the end of each G-code command
2. **Use internal units** for all calculations (mm, °C, mm/s)
3. **Reference Marlin docs** in comments above each coder method
4. **Return empty string** for invalid/no-op conditions
