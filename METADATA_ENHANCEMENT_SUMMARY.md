# G-code Metadata Enhancement - Summary

## Overview

This PR enhances the G-code metadata header to include comprehensive print statistics that help users estimate material costs, plan print schedules, and track filament usage.

## Changes Made

### 1. New Metadata Fields

The G-code metadata header now includes:

- **Total Layers**: Number of layers in the print
- **Filament Length**: Total filament consumed in millimeters
- **Material Volume**: Volume of material in cubic millimeters
- **Material Weight**: Weight of material in grams (when filament density is available)
- **Estimated Print Time**: Formatted as HH:MM:SS

### 2. Implementation Details

#### Tracking Variables (`src/slicer/slice.coffee`)

Added tracking initialization at the start of slicing:
```coffeescript
# Initialize print statistics tracking.
slicer.totalFilamentLength = 0 # Total filament extruded (mm).
slicer.totalPrintTime = 0 # Total print time (seconds).
slicer.totalLayers = 0 # Number of layers printed.
```

Stored final statistics after slicing:
```coffeescript
# Store final print statistics after all layers are processed.
slicer.totalFilamentLength = slicer.cumulativeE # Final extrusion value equals total filament used (mm).
slicer.totalLayers = totalLayers
```

#### Print Time Calculation (`src/slicer/gcode/coders.coffee`)

Added `calculatePrintTime()` function that:
- Parses all movement commands (G0, G1, G2, G3) and calculates time based on distance and feedrate
- Parses dwell commands (G4) for explicit delays
- Adds estimated heating times (30s for nozzle, 60s for bed)
- Returns total time in seconds

Added `formatTime()` helper to format seconds as HH:MM:SS.

#### Metadata Update (`src/slicer/gcode/coders.coffee`)

Added `updateMetadataWithStats()` function that:
- Finds the metadata block in generated G-code
- Inserts statistics before the blank line that ends metadata
- Calculates material volume using filament diameter
- Calculates material weight using filament density (if available)
- Formats and inserts all new metadata fields

This function is called at the end of `slice()` after all G-code is generated.

### 3. Example Output

```gcode
; Generated by Polyslice
; Version: 26.1.1
; Timestamp: 2026-01-25T07:29:30.545Z
; Repository: https://github.com/jgphilpott/polyslice
; Printer: Ender3
; Filament: Generic PLA (pla)
; Nozzle Temp: 200Â°C
; Bed Temp: 60Â°C
; Layer Height: 0.2mm
; Total Layers: 50
; Filament Length: 209.21mm
; Material Volume: 503.2mmÂ³
; Material Weight: 0.62g
; Estimated Print Time: 00:04:36
```

### 4. Material Calculations

```javascript
// Filament length = cumulative extrusion (E values)
filamentLength = slicer.totalFilamentLength;

// Volume = Ï€ Ã— (diameter/2)Â² Ã— length
filamentRadius = filamentDiameter / 2;
volume = Math.PI Ã— filamentRadiusÂ² Ã— filamentLength;

// Weight = volume (cmÂ³) Ã— density (g/cmÂ³)
weight = (volume / 1000) Ã— filamentDensity;
```

### 5. Tests Added

Added 4 comprehensive tests in `src/slicer/gcode/coders.test.coffee`:

1. **should include print statistics in metadata after slicing** - Verifies all new fields are present
2. **should calculate print time correctly** - Validates time calculation and format
3. **should format time correctly** - Tests the HH:MM:SS formatter
4. **should calculate material volume and weight** - Verifies material calculations

All 657 tests pass including the new ones.

### 6. Documentation

#### Updated Files:

- **`docs/slicer/gcode/GCODE.md`**: Added comprehensive documentation for new metadata fields including:
  - Table of all fields with descriptions
  - Print time calculation details
  - Material calculation formulas
  - Usage examples with Filament configuration
  
- **`README.md`**: Added new feature row in the features table:
  - ðŸ“Š **Print statistics** - Automatic calculation of filament usage, material weight, and print time

#### Demo Example:

Created `examples/metadata-demo.js` that demonstrates the new metadata with various geometries (cube, sphere, cylinder).

## Benefits

### For Users:
- **Material Cost Estimation**: Know exactly how much filament will be used before printing
- **Print Planning**: Schedule prints based on accurate time estimates
- **Filament Tracking**: Monitor filament consumption across multiple prints
- **Print Optimization**: Compare different settings to find the most efficient configuration

### For Developers:
- **Non-Breaking**: Existing code continues to work without changes
- **Opt-In**: Metadata can be disabled if not needed (`metadata: false`)
- **Extensible**: Easy to add more statistics in the future
- **Well-Tested**: Comprehensive test coverage ensures reliability

## Example Usage

```javascript
const THREE = require('three');
const { Polyslice, Printer, Filament } = require('@jgphilpott/polyslice');

// Create printer and filament for complete metadata
const printer = new Printer('Ender3');
const filament = new Filament('GenericPLA');

const slicer = new Polyslice({
    printer: printer,
    filament: filament,
    metadata: true  // Enabled by default
});

// Create and slice a model
const geometry = new THREE.BoxGeometry(20, 20, 20);
const mesh = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial());
const gcode = slicer.slice(mesh);

// Access statistics programmatically
console.log('Layers:', slicer.totalLayers);
console.log('Filament:', slicer.totalFilamentLength, 'mm');
```

## Performance Impact

- **Compilation**: No significant impact on slicing performance
- **Time Calculation**: Post-processing step that parses generated G-code once
- **File Size**: Adds ~5 lines of metadata comments (negligible)
- **Memory**: Minimal additional memory for tracking variables

## Testing

Run the demo to see the new metadata in action:

```bash
npm run compile
npm run build
node examples/metadata-demo.js
```

Run the full test suite:

```bash
npm test
```

All 657 tests pass, including 4 new tests for the metadata enhancements.
